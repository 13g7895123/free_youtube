# CI/CD éƒ¨ç½²æŒ‡å—

## æ¦‚è¿°

æœ¬å°ˆæ¡ˆä½¿ç”¨ GitHub Actions å¯¦ç¾è‡ªå‹•åŒ–éƒ¨ç½²ï¼Œæ”¯æ´é–‹ç™¼ç’°å¢ƒå’Œæ­£å¼ç’°å¢ƒçš„åˆ†é›¢éƒ¨ç½²ã€‚

## éƒ¨ç½²æµç¨‹

### ğŸ”„ è‡ªå‹•è§¸ç™¼è¦å‰‡

```yaml
master åˆ†æ”¯æ¨é€  â†’ è‡ªå‹•éƒ¨ç½²åˆ°æ­£å¼ç’°å¢ƒ (deploy-prod.sh)
develop åˆ†æ”¯æ¨é€ â†’ è‡ªå‹•éƒ¨ç½²åˆ°é–‹ç™¼ç’°å¢ƒ (deploy.sh)
```

### ğŸ“‹ éƒ¨ç½²ä»»å‹™

#### 1. Production Deployment (æ­£å¼ç’°å¢ƒ)
- **è§¸ç™¼æ¢ä»¶**: `master` åˆ†æ”¯ push äº‹ä»¶
- **éƒ¨ç½²è…³æœ¬**: `deploy-prod.sh`
- **ç’°å¢ƒé…ç½®**: ä½¿ç”¨ `.env` (å¾ `.env.prod.example` è¤‡è£½)
- **Docker é…ç½®**: `docker-compose.prod.yml`
- **ç‰¹æ€§**:
  - å¤šéšæ®µæ§‹å»ºå„ªåŒ–
  - ç”Ÿç”¢ç’°å¢ƒå®‰å…¨é…ç½®
  - å¥åº·æª¢æŸ¥å’Œæ—¥èªŒç®¡ç†
  - è‡ªå‹•å‚™ä»½æç¤º

#### 2. Development Deployment (é–‹ç™¼ç’°å¢ƒ)
- **è§¸ç™¼æ¢ä»¶**: `develop` åˆ†æ”¯ push äº‹ä»¶
- **éƒ¨ç½²è…³æœ¬**: `deploy.sh`
- **ç’°å¢ƒé…ç½®**: ä½¿ç”¨ `.env` (å¾ `.env.example` è¤‡è£½)
- **Docker é…ç½®**: `docker-compose.yml`
- **ç‰¹æ€§**:
  - å¿«é€Ÿæ§‹å»º
  - é–‹ç™¼å·¥å…·é›†æˆ
  - ç†±é‡è¼‰æ”¯æ´

## éƒ¨ç½²æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     GitHub Repository                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                     â”‚
                â”‚                     â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   master branch      â”‚  â”‚  develop branch     â”‚
    â”‚   (Production)       â”‚  â”‚  (Development)      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                     â”‚
                â”‚ GitHub Actions      â”‚ GitHub Actions
                â”‚                     â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  deploy-production   â”‚  â”‚  deploy-development â”‚
    â”‚  Job                 â”‚  â”‚  Job                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                     â”‚
                â”‚ SSH                 â”‚ SSH
                â”‚                     â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  VPS Server          â”‚  â”‚  VPS Server         â”‚
    â”‚  deploy-prod.sh      â”‚  â”‚  deploy.sh          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                     â”‚
                â”‚                     â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Production Env      â”‚  â”‚  Development Env    â”‚
    â”‚  Port: 80, 8080      â”‚  â”‚  Port: 80, 8080     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ‰€éœ€çš„ GitHub Secrets

åœ¨ GitHub Repository è¨­å®šä¸­é…ç½®ä»¥ä¸‹ Secretsï¼š

```
SSH_PRIVATE_KEY    # SSH ç§é‘° (ç”¨æ–¼é€£æ¥ VPS)
SSH_HOST          # VPS ä¸»æ©Ÿåœ°å€
SSH_USER          # SSH ç”¨æˆ¶å
```

### è¨­å®šæ­¥é©Ÿ

1. **ç”Ÿæˆ SSH é‡‘é‘°** (å¦‚æœé‚„æ²’æœ‰)
   ```bash
   ssh-keygen -t ed25519 -C "github-actions@deploy"
   ```

2. **æ·»åŠ å…¬é‘°åˆ° VPS**
   ```bash
   ssh-copy-id -i ~/.ssh/id_ed25519.pub user@vps-host
   ```

3. **åœ¨ GitHub è¨­å®š Secrets**
   - é€²å…¥ Repository â†’ Settings â†’ Secrets and variables â†’ Actions
   - æ·»åŠ ä»¥ä¸‹ secrets:
     - `SSH_PRIVATE_KEY`: ç§é‘°å…§å®¹ (cat ~/.ssh/id_ed25519)
     - `SSH_HOST`: VPS IP æˆ–åŸŸå
     - `SSH_USER`: SSH ç”¨æˆ¶å

## éƒ¨ç½²æµç¨‹è©³è§£

### Production Deployment æµç¨‹

```bash
1. ğŸ“¥ Checkout source code
2. ğŸ”‘ Setup SSH key
3. ğŸ”— Connect to VPS via SSH
4. ğŸ“¥ Pull latest changes (git pull)
5. ğŸ”§ Make scripts executable
   - chmod +x deploy-prod.sh
   - chmod +x backend/docker-entrypoint.prod.sh
6. ğŸš€ Execute deployment
   - ./deploy-prod.sh
7. âœ… Verify deployment
```

### deploy-prod.sh åŸ·è¡Œå…§å®¹

```bash
1. âœ… å‰ç½®æª¢æŸ¥ (Docker, å°ˆæ¡ˆçµæ§‹)
2. âœ… ç’°å¢ƒé…ç½®æª¢æŸ¥ (.env, å¯†ç¢¼é©—è­‰)
3. âœ… æ•¸æ“šå‚™ä»½ (å¯é¸)
4. âœ… åœæ­¢ç¾æœ‰æœå‹™
5. âœ… æ§‹å»º Docker é¡åƒ (å¤šéšæ®µæ§‹å»º)
6. âœ… å•Ÿå‹•æœå‹™
7. âœ… å¥åº·æª¢æŸ¥
8. âœ… é©—è­‰éƒ¨ç½²
```

## éƒ¨ç½²ç›£æ§

### æŸ¥çœ‹ GitHub Actions æ—¥èªŒ

1. é€²å…¥ Repository â†’ Actions
2. é¸æ“‡æœ€è¿‘çš„ workflow run
3. æŸ¥çœ‹ `deploy-production` æˆ– `deploy-development` job æ—¥èªŒ

### æŸ¥çœ‹ VPS éƒ¨ç½²æ—¥èªŒ

```bash
# SSH é€£æ¥åˆ° VPS
ssh -p 8022 user@vps-host

# æŸ¥çœ‹ Docker æ—¥èªŒ
cd /home/jarvis/project/idea/free_youtube

# æ­£å¼ç’°å¢ƒæ—¥èªŒ
docker compose -f docker-compose.prod.yml logs -f

# é–‹ç™¼ç’°å¢ƒæ—¥èªŒ
docker compose logs -f
```

## æ‰‹å‹•éƒ¨ç½²

å¦‚æœéœ€è¦æ‰‹å‹•éƒ¨ç½²ï¼š

### æ­£å¼ç’°å¢ƒ

```bash
# SSH åˆ° VPS
ssh -p 8022 user@vps-host

# é€²å…¥å°ˆæ¡ˆç›®éŒ„
cd /home/jarvis/project/idea/free_youtube

# æ‹‰å–æœ€æ–°ä»£ç¢¼
git pull

# åŸ·è¡Œéƒ¨ç½²
./deploy-prod.sh
```

### é–‹ç™¼ç’°å¢ƒ

```bash
# SSH åˆ° VPS
ssh -p 8022 user@vps-host

# é€²å…¥å°ˆæ¡ˆç›®éŒ„
cd /home/jarvis/project/idea/free_youtube

# æ‹‰å–æœ€æ–°ä»£ç¢¼
git pull

# åŸ·è¡Œéƒ¨ç½²
./deploy.sh
```

## å›æ»¾ç­–ç•¥

### ä½¿ç”¨ Git å›æ»¾

```bash
# SSH åˆ° VPS
ssh -p 8022 user@vps-host
cd /home/jarvis/project/idea/free_youtube

# æŸ¥çœ‹æäº¤æ­·å²
git log --oneline -10

# å›æ»¾åˆ°ç‰¹å®šç‰ˆæœ¬
git reset --hard <commit-hash>

# é‡æ–°éƒ¨ç½²
./deploy-prod.sh  # æˆ– ./deploy.sh
```

### ä½¿ç”¨ Docker å›æ»¾

```bash
# æŸ¥çœ‹ Docker é¡åƒæ­·å²
docker images | grep free_youtube

# ä½¿ç”¨èˆŠçš„é¡åƒæ¨™ç±¤é‡å•Ÿ
docker compose -f docker-compose.prod.yml down
# ä¿®æ”¹ docker-compose.prod.yml ä½¿ç”¨èˆŠçš„é¡åƒ
docker compose -f docker-compose.prod.yml up -d
```

## å¸¸è¦‹å•é¡Œ

### Q1: éƒ¨ç½²å¤±æ•—æ€éº¼è¾¦ï¼Ÿ

1. æª¢æŸ¥ GitHub Actions æ—¥èªŒ
2. SSH åˆ° VPS æª¢æŸ¥è©³ç´°æ—¥èªŒ
   ```bash
   docker compose -f docker-compose.prod.yml logs
   ```
3. æª¢æŸ¥ `.env` é…ç½®æ˜¯å¦æ­£ç¢º
4. æª¢æŸ¥ç£ç›¤ç©ºé–“æ˜¯å¦å……è¶³
   ```bash
   df -h
   docker system df
   ```

### Q2: SSH é€£æ¥å¤±æ•—

- æª¢æŸ¥ SSH_PRIVATE_KEY æ˜¯å¦æ­£ç¢ºè¨­å®š
- æª¢æŸ¥ SSH_HOST å’Œ SSH_USER æ˜¯å¦æ­£ç¢º
- ç¢ºèª VPS é˜²ç«ç‰†è¦å‰‡å…è¨± GitHub Actions IP

### Q3: Docker æ§‹å»ºå¤±æ•—

- æª¢æŸ¥ Dockerfile èªæ³•
- æª¢æŸ¥ç£ç›¤ç©ºé–“
- æ¸…ç†èˆŠçš„ Docker è³‡æº
  ```bash
  docker system prune -a
  ```

### Q4: æœå‹™ç„¡æ³•è¨ªå•

- æª¢æŸ¥å®¹å™¨ç‹€æ…‹
  ```bash
  docker compose -f docker-compose.prod.yml ps
  ```
- æª¢æŸ¥ç«¯å£æ˜¯å¦è¢«ä½”ç”¨
  ```bash
  netstat -tulpn | grep -E '80|8080'
  ```
- æª¢æŸ¥é˜²ç«ç‰†è¦å‰‡

## æœ€ä½³å¯¦è¸

### 1. åˆ†æ”¯ç®¡ç†
- `master` åˆ†æ”¯: åƒ…ç”¨æ–¼æ­£å¼ç’°å¢ƒï¼Œä¿æŒç©©å®š
- `develop` åˆ†æ”¯: é–‹ç™¼ç’°å¢ƒï¼Œæ¸¬è©¦æ–°åŠŸèƒ½
- ä½¿ç”¨ Pull Request åˆä½µåˆ° master

### 2. éƒ¨ç½²å‰æª¢æŸ¥
- âœ… æœ¬åœ°æ¸¬è©¦é€šé
- âœ… Code Review å®Œæˆ
- âœ… æ›´æ–° CHANGELOG
- âœ… ç¢ºèªç’°å¢ƒè®Šæ•¸é…ç½®æ­£ç¢º

### 3. éƒ¨ç½²å¾Œé©—è­‰
- âœ… æª¢æŸ¥æœå‹™å¥åº·ç‹€æ…‹
- âœ… è¨ªå•æ‡‰ç”¨ç¢ºèªåŠŸèƒ½æ­£å¸¸
- âœ… æŸ¥çœ‹æ—¥èªŒç¢ºèªç„¡éŒ¯èª¤
- âœ… ç›£æ§è³‡æºä½¿ç”¨æƒ…æ³

### 4. å®‰å…¨å»ºè­°
- ğŸ”’ å®šæœŸæ›´æ› SSH å¯†é‘°
- ğŸ”’ ä½¿ç”¨å¼·å¯†ç¢¼
- ğŸ”’ å•Ÿç”¨ 2FA (å¦‚æœå¯èƒ½)
- ğŸ”’ é™åˆ¶ SSH è¨ªå• IP
- ğŸ”’ å®šæœŸå‚™ä»½æ•¸æ“š

## ç’°å¢ƒè®Šæ•¸ç®¡ç†

### Production (.env)
```bash
# å¾ç¯„ä¾‹è¤‡è£½
cp .env.prod.example .env

# ä¿®æ”¹ç‚ºæ­£å¼ç’°å¢ƒé…ç½®
MYSQL_ROOT_PASSWORD=<strong-password>
MYSQL_PASSWORD=<strong-password>
FRONTEND_PORT=80
BACKEND_PORT=8080
```

### Development (.env)
```bash
# å¾ç¯„ä¾‹è¤‡è£½
cp .env.example .env

# å¯ä»¥ä½¿ç”¨è¼ƒç°¡å–®çš„é…ç½®
MYSQL_ROOT_PASSWORD=secret
MYSQL_PASSWORD=password
```

## ç›£æ§å’Œå‘Šè­¦

å»ºè­°è¨­ç½®ä»¥ä¸‹ç›£æ§ï¼š

1. **æ‡‰ç”¨ç›£æ§**
   - æœå‹™å¥åº·ç‹€æ…‹
   - éŸ¿æ‡‰æ™‚é–“
   - éŒ¯èª¤ç‡

2. **è³‡æºç›£æ§**
   - CPU ä½¿ç”¨ç‡
   - è¨˜æ†¶é«”ä½¿ç”¨ç‡
   - ç£ç›¤ç©ºé–“

3. **æ—¥èªŒç›£æ§**
   - éŒ¯èª¤æ—¥èªŒ
   - è¨ªå•æ—¥èªŒ
   - å®‰å…¨æ—¥èªŒ

## ç›¸é—œæ–‡æª”

- [æ­£å¼ç’°å¢ƒéƒ¨ç½²æ–‡æª”](DEPLOYMENT_PROD.md)
- [é–‹ç™¼ç’°å¢ƒè¨­ç½®](README.md)
- [Docker é…ç½®èªªæ˜](docker-compose.prod.yml)

## æ”¯æ´

å¦‚æœ‰å•é¡Œï¼Œè«‹ï¼š
1. æŸ¥çœ‹ GitHub Actions æ—¥èªŒ
2. æŸ¥çœ‹ Docker å®¹å™¨æ—¥èªŒ
3. åƒè€ƒæœ¬æ–‡æª”çš„å¸¸è¦‹å•é¡Œéƒ¨åˆ†
4. æäº¤ GitHub Issue
