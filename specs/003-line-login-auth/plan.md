# Implementation Plan: LINE Login 會員認證系統

**Branch**: `003-line-login-auth` | **Date**: 2025-11-01 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/003-line-login-auth/spec.md`

**Note**: This plan is generated by `/speckit.plan` command.

## Summary

本功能實作 LINE Login OAuth 2.0 會員認證系統,為 YouTube Loop Player 新增會員管理功能。核心需求包含:

1. **會員認證**: LINE Login 作為唯一登入方式,支援 OAuth 2.0 流程
2. **權限控制**: 未登入訪客僅能使用播放器,已登入會員可存取影片庫和播放清單
3. **資料隔離**: 每個會員擁有獨立的影片庫和播放清單,互不可見
4. **資料遷移**: 訪客登入後自動遷移播放歷史
5. **軟刪除**: 帳號刪除後保留 30 天,可恢復

**技術方案**: 使用現有技術堆疊 (Vue 3 + Pinia + CodeIgniter 4 + MySQL),零新增套件,遵循專案憲章的最小化變更原則。詳見 [research.md](./research.md)。

## Technical Context

**Language/Version**:
- Frontend: JavaScript ES2020+ (Vue 3 Composition API)
- Backend: PHP 8.1+

**Primary Dependencies** (現有,不新增):
- Frontend: Vue 3.5.22, Pinia 3.0.3, Vue Router 4.6.3, Axios 1.13.0, Vite 5.4.21
- Backend: CodeIgniter 4.4+

**Storage**: MySQL (現有資料庫)

**Testing**:
- Frontend: Vitest 2.1.9, Playwright 1.56.1
- Backend: PHPUnit 9.5+

**Target Platform**: Web (瀏覽器 + Linux server)

**Project Type**: Web application (前後端分離)

**Performance Goals**:
- LINE OAuth 完整流程 < 30 秒 (SC-002)
- UI 狀態切換 < 1 秒 (SC-003, SC-004)
- 訪客資料遷移 < 5 秒 (SC-008)
- 支援 1000+ 同時在線 (SC-006)

**Constraints**:
- ✅ 零新增 npm/composer 套件 (憲章要求)
- ✅ 最小化變更現有程式碼 (憲章要求)
- HTTP-only cookies (安全性要求)
- 30 天軟刪除保留期 (FR-018-020)

**Scale/Scope**:
- 預期使用者: 1000 同時在線
- 資料量: 每會員最多 10000 影片
- 新增 6 個資料表
- 前端新增約 10 個元件/頁面
- 後端新增約 15 個 API 端點

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### ✅ 第一次檢查 (Phase 0 前)

| 憲章原則 | 狀態 | 說明 |
|---------|------|------|
| 尊重棕地專案 | ✅ PASS | 僅新增功能,不重構現有程式碼 |
| 最小化變更 | ✅ PASS | 僅新增必要檔案和資料表,不觸碰現有檔案 |
| 需要明確許可 | ✅ PASS | 使用者明確要求「加入會員功能」 |
| 測試紀律 | ✅ PASS | 不修改現有測試,僅新增認證相關測試 |
| 技術堆疊穩定性 | ✅ PASS | 使用現有 Vue 3 + CodeIgniter 4,不升級版本 |

### ✅ 第二次檢查 (Phase 1 設計後)

| 憲章原則 | 狀態 | 說明 |
|---------|------|------|
| 尊重棕地專案 | ✅ PASS | 設計方案僅新增獨立模組,不影響現有功能 |
| 最小化變更 | ✅ PASS | 資料庫僅新增 6 個表,前端僅新增認證相關元件 |
| 需要明確許可 | ✅ PASS | 使用者已確認使用 LINE Login (唯一登入方式) |
| 測試紀律 | ✅ PASS | 測試策略明確,不影響現有測試套件 |
| 技術堆疊穩定性 | ✅ PASS | 零新增套件,完全使用現有依賴實現 |

**結論**: 所有憲章原則檢查通過 ✅

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
backend/
├── app/
│   ├── Controllers/
│   │   ├── Auth.php                  # 新增: LINE Login 認證控制器
│   │   ├── VideoLibrary.php          # 新增: 影片庫控制器
│   │   └── Playlists.php             # 新增: 播放清單控制器
│   ├── Models/
│   │   ├── UserModel.php             # 新增: 會員模型
│   │   ├── UserTokenModel.php        # 新增: Token 模型
│   │   ├── VideoLibraryModel.php     # 新增: 影片庫模型
│   │   ├── PlaylistModel.php         # 新增: 播放清單模型
│   │   ├── PlaylistItemModel.php     # 新增: 播放清單項目模型
│   │   └── GuestSessionModel.php     # 新增: 訪客暫存資料模型
│   ├── Filters/
│   │   └── AuthFilter.php            # 新增: 認證過濾器
│   ├── Database/
│   │   └── Migrations/
│   │       └── 2025110100_create_line_login_tables.php  # 新增: 資料庫遷移
│   └── Config/
│       └── Routes.php                # 修改: 新增 API 路由
└── tests/
    └── unit/
        ├── UserModelTest.php         # 新增: 會員模型測試
        └── VideoLibraryModelTest.php # 新增: 影片庫模型測試

frontend/
├── src/
│   ├── stores/
│   │   └── auth.js                   # 新增: 認證 Store (Pinia)
│   ├── components/
│   │   ├── auth/
│   │   │   ├── LoginButton.vue       # 新增: 登入按鈕元件
│   │   │   └── UserMenu.vue          # 新增: 使用者選單元件
│   │   └── common/
│   │       └── Toast.vue             # 新增: 提示訊息元件
│   ├── views/
│   │   ├── VideoLibrary.vue          # 新增: 影片庫頁面
│   │   └── Playlists.vue             # 新增: 播放清單頁面
│   ├── services/
│   │   └── axios.js                  # 修改: 新增認證 interceptor
│   └── router/
│       └── index.js                  # 修改: 新增路由守衛
└── tests/
    ├── unit/
    │   └── stores/
    │       └── auth.spec.js          # 新增: Auth Store 測試
    └── e2e/
        └── auth.spec.js              # 新增: E2E 認證測試
```

**Structure Decision**: Web application (前後端分離)

**新增檔案**:
- Backend: 9 個新檔案 (Controllers, Models, Filters, Migrations)
- Frontend: 9 個新檔案 (Store, Components, Views, Tests)
- **總計**: 18 個新檔案

**修改檔案**:
- Backend: 1 個 (Routes.php)
- Frontend: 2 個 (axios.js, router/index.js)
- **總計**: 3 個修改檔案

**變更影響**: 最小化,所有新增檔案都是獨立模組,不影響現有功能。

## Complexity Tracking

> **本功能無憲章違規,此區塊為空**

本功能完全符合專案憲章所有原則,無需複雜度權衡或豁免。
