# Feature Specification: LINE Login 會員認證系統

**Feature Branch**: `003-line-login-auth`
**Created**: 2025-11-01
**Status**: Draft
**Input**: User description: "功能一,幫我為這個專案加入會員的功能,如果沒有登入,只能看到播放器的頁面,且登入的功能整合line login,只有這個登入方法,右上角多一顆登入的按鈕
功能二,沒有登入會員的話只會出現播放器的選項,沒有影片庫與播放清單
功能三,影片庫與播放清單會掛在會員底下,不同會員間不能看到對方的影片庫與播放清單"

## Clarifications

### Session 2025-11-01

- Q: 當使用者取消 LINE 授權或 OAuth 流程失敗時,系統應該如何回應? → A: 顯示友善錯誤訊息(如「登入已取消」或「登入失敗,請稍後再試」),停留在原頁面
- Q: 當會員登入後長時間無操作導致會話逾時,系統應該如何處理? → A: 自動登出並顯示提示訊息「您的登入已逾時,請重新登入」,提供重新登入按鈕
- Q: 當同一個 LINE 帳號在不同裝置或瀏覽器登入時,系統應該如何處理? → A: 允許多裝置同時登入,每個裝置維持獨立的會話
- Q: 當訪客在未登入狀態下已使用播放器一段時間後登入,系統是否需要保留或遷移任何暫存資料? → A: 將訪客的播放歷史和暫存資料遷移到新登入的會員帳號下
- Q: 當使用者刪除 LINE 帳號或取消應用授權後,系統應該如何處理該會員的資料? → A: 軟刪除:保留資料 30 天,期間內若重新授權可恢復,30 天後永久刪除

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 訪客使用播放器 (Priority: P1)

未登入的訪客可以直接使用 YouTube 循環播放器的基本功能,貼上影片網址即可播放。

**Why this priority**: 這是系統的核心價值,即使沒有會員功能,播放器本身也必須能夠獨立運作。這是最小可行產品(MVP)的基礎。

**Independent Test**: 可以透過訪問網站首頁,不進行任何登入操作,直接貼上 YouTube 網址並成功播放影片來測試。這個功能完全獨立,不依賴任何會員系統。

**Acceptance Scenarios**:

1. **Given** 訪客進入網站首頁, **When** 未進行任何登入操作, **Then** 可以看到播放器介面
2. **Given** 訪客在播放器介面, **When** 貼上有效的 YouTube 影片網址, **Then** 影片可以正常播放並循環
3. **Given** 訪客在播放器介面, **When** 查看導航選單或功能列表, **Then** 只能看到播放器相關功能,不顯示影片庫和播放清單選項

---

### User Story 2 - 會員透過 LINE 登入 (Priority: P2)

訪客可以透過頁面右上角的 LINE 登入按鈕進行身份認證,成為會員。

**Why this priority**: 會員認證是解鎖進階功能(影片庫、播放清單)的前提。LINE Login 是台灣用戶熟悉且信任的認證方式,能降低註冊門檻。

**Independent Test**: 可以透過點擊右上角登入按鈕,完成 LINE OAuth 流程,並在登入後看到使用者資訊來測試。此功能可獨立於影片庫和播放清單功能進行開發和驗證。

**Acceptance Scenarios**:

1. **Given** 訪客在任何頁面, **When** 查看頁面右上角, **Then** 可以看到「LINE 登入」按鈕
2. **Given** 訪客點擊登入按鈕, **When** 完成 LINE OAuth 授權流程, **Then** 系統建立或更新會員資料,並返回已登入狀態
3. **Given** 會員已登入, **When** 查看頁面右上角, **Then** 登入按鈕變更為會員資訊顯示(如頭像、暱稱)和登出選項
4. **Given** 會員已登入, **When** 關閉瀏覽器後重新開啟網站, **Then** 會員狀態保持登入(在合理的時效內)

---

### User Story 3 - 會員管理個人影片庫與播放清單 (Priority: P3)

已登入的會員可以將喜愛的影片加入個人影片庫,並建立和管理個人播放清單。

**Why this priority**: 這是會員的核心價值功能,讓用戶能夠組織和管理自己的影片收藏。雖然重要,但必須建立在 P1(播放器)和 P2(認證)的基礎之上。

**Independent Test**: 可以透過登入後訪問影片庫和播放清單頁面,執行新增、編輯、刪除影片和播放清單的操作來測試。可以驗證不同會員間的資料隔離性。

**Acceptance Scenarios**:

1. **Given** 會員已登入, **When** 查看導航選單, **Then** 可以看到「影片庫」和「播放清單」選項
2. **Given** 會員在播放器播放影片, **When** 選擇加入影片庫或播放清單, **Then** 影片被保存到該會員的個人影片庫/播放清單中
3. **Given** 會員 A 建立了影片庫和播放清單, **When** 會員 B 登入系統, **Then** 會員 B 無法看到或存取會員 A 的影片庫和播放清單
4. **Given** 會員建立多個播放清單, **When** 查看播放清單列表, **Then** 可以瀏覽、編輯、刪除自己的播放清單
5. **Given** 會員在影片庫中, **When** 選擇移除某個影片, **Then** 該影片從會員的影片庫中移除(不影響其他會員的影片庫)

---

### Edge Cases

- **登入失敗處理**: 當 LINE OAuth 流程失敗或被使用者取消時,系統必須顯示友善的錯誤訊息(如「登入已取消」或「登入失敗,請稍後再試」),並保持使用者停留在原頁面。
- **會話逾時**: 當會員登入後長時間無操作導致會話逾時,系統必須自動登出會員,顯示提示訊息「您的登入已逾時,請重新登入」,並提供重新登入按鈕。
- **多裝置登入**: 系統必須允許同一個 LINE 帳號在多個裝置或瀏覽器同時登入,每個裝置維持獨立的會話,互不干擾。
- **訪客資料遷移**: 當訪客在未登入狀態下使用播放器後首次登入,系統必須將訪客的播放歷史和暫存資料自動遷移到新登入的會員帳號下,確保使用體驗的連續性。
- **權限變更**: 會員在使用過程中登出,系統必須立即反映權限變更(在 1 秒內隱藏影片庫和播放清單選項)。
- **帳號刪除與資料保留**: 當使用者刪除 LINE 帳號或取消應用授權後,系統必須採用軟刪除機制:保留會員資料 30 天,期間內若使用者重新授權可完全恢復,30 天後永久刪除所有資料。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統必須在頁面右上角提供 LINE 登入按鈕,作為唯一的登入方式
- **FR-002**: 系統必須整合 LINE Login OAuth 2.0 認證流程,取得使用者授權
- **FR-003**: 系統必須在 LINE 認證成功後,使用 LINE User ID 建立或識別會員資料
- **FR-004**: 系統必須在會員登入後保持會話狀態,在 30 天內 (2592000 秒) 免除重複登入
- **FR-005**: 系統必須為未登入的訪客提供播放器功能,不限制基本播放能力
- **FR-006**: 系統必須對未登入的訪客隱藏影片庫和播放清單功能選項
- **FR-007**: 系統必須在會員登入後顯示影片庫和播放清單功能選項
- **FR-008**: 系統必須將每個會員的影片庫資料與該會員的帳號綁定
- **FR-009**: 系統必須將每個會員的播放清單資料與該會員的帳號綁定
- **FR-010**: 系統必須確保會員只能存取自己的影片庫資料,無法檢視或修改其他會員的影片庫
- **FR-011**: 系統必須確保會員只能存取自己的播放清單資料,無法檢視或修改其他會員的播放清單
- **FR-012**: 系統必須提供登出功能,清除會員的登入狀態
- **FR-013**: 系統必須在登出後將使用者導向訪客可見的頁面(播放器頁面)
- **FR-014**: 系統必須在 LINE OAuth 流程失敗或被使用者取消時,顯示友善的錯誤訊息並保持使用者在原頁面
- **FR-015**: 系統必須在會話逾時時自動登出會員,顯示「您的登入已逾時,請重新登入」訊息,並提供重新登入按鈕
- **FR-016**: 系統必須允許同一個會員帳號在多個裝置或瀏覽器同時登入,每個裝置維持獨立的會話
  - **實現方式**: 採用 token-based 無狀態認證機制,每次 LINE OAuth 登入時為該裝置/瀏覽器產生獨立的 access_token 與 refresh_token,儲存於 user_tokens 資料表中。每個 token 包含裝置資訊 (User-Agent, IP) 以利追蹤。系統不限制同一會員的 active tokens 數量,每個裝置的會話獨立過期與更新,互不影響。
- **FR-017**: 系統必須在訪客首次登入時,自動將訪客期間的播放歷史和暫存資料遷移到會員帳號下
- **FR-018**: 系統必須在使用者刪除 LINE 帳號或取消應用授權時,將會員資料標記為軟刪除狀態,保留 30 天
- **FR-019**: 系統必須允許軟刪除狀態的會員在 30 天內重新授權並完全恢復其資料
- **FR-020**: 系統必須在軟刪除 30 天後自動永久刪除會員的所有資料(影片庫、播放清單、個人資料)

### Key Entities

- **會員 (Member)**: 透過 LINE Login 認證的使用者,具有唯一的 LINE User ID、顯示名稱、頭像等基本資訊。每個會員擁有獨立的影片庫和播放清單。會員具有狀態屬性:活躍(active)、軟刪除(soft_deleted),軟刪除狀態包含刪除時間戳記用於判斷 30 天期限。
- **影片庫 (Video Library)**: 屬於特定會員的影片收藏集合,儲存會員加入的 YouTube 影片參考資訊(如影片 ID、標題、縮圖等)。
- **播放清單 (Playlist)**: 屬於特定會員的影片組織結構,包含播放清單名稱、描述,以及該播放清單中的影片項目順序。
- **播放清單項目 (Playlist Item)**: 播放清單中的單一影片項目,包含影片參考和在播放清單中的位置。
- **訪客暫存資料 (Guest Session Data)**: 訪客使用播放器期間產生的暫存資料,儲存於瀏覽器 LocalStorage 中。包含欄位:
  - **播放歷史 (play_history)**: 訪客播放過的影片清單,包含影片 ID、標題、縮圖、最後播放時間戳記
  - **會話 ID (session_id)**: 用於識別訪客會話的唯一標識符
  在訪客首次登入時,系統自動將播放歷史遷移到會員的影片庫中。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 訪客在未登入狀態下可以在 10 秒內成功播放一個 YouTube 影片
- **SC-002**: 會員可以在 30 秒內完成 LINE Login 認證流程(從點擊登入按鈕到返回已登入狀態)
- **SC-003**: 會員登入後,影片庫和播放清單選項即時顯示(1 秒內)
- **SC-004**: 會員登出後,影片庫和播放清單選項即時隱藏(1 秒內)
- **SC-005**: 100% 的會員資料查詢請求必須通過身份驗證和授權檢查,確保資料隔離
- **SC-006**: 系統支援至少 1000 個會員同時在線,每個會員可擁有至少 500 個影片庫項目
- **SC-007**: 90% 的使用者能在首次使用時成功完成登入流程,不需要額外說明或協助
- **SC-008**: 訪客首次登入時,100% 的訪客暫存資料能在 5 秒內成功遷移到會員帳號
- **SC-009**: 軟刪除狀態的會員在 30 天內重新授權,100% 能完全恢復其原有資料(影片庫、播放清單)

## Assumptions

- 使用者已擁有 LINE 帳號(LINE 在台灣的高普及率)
- 使用者願意授權應用程式存取基本 LINE 個人資料(顯示名稱、頭像)
- 會話逾時時間固定為 30 天 (2592000 秒),超過後自動登出
- 影片庫和播放清單的資料量在合理範圍內(每個會員不超過 10000 個影片),系統必須在 API 層級強制執行此上限,當達到上限時拒絕新增操作並返回友善錯誤訊息
- 系統採用標準的 session-based 或 token-based 認證機制
- 會員資料遵循個人資料保護法規,提供適當的隱私政策和使用者同意流程
- LINE Login 服務的可用性和穩定性符合一般 OAuth 提供商的標準(99.9% uptime)
